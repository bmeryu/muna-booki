# Objetivo

Dejar **checkout.html** funcionando con:

* Chequeo de **allowlist** primero (si est√° activo, redirige a `mi-cuenta.html` y NO monta Mercado Pago).
* Soporte para **m√°s de un producto** sin romper nada: si hay checkboxes en la p√°gina, suma los seleccionados; si no, sigue funcionando con `?plan=` (biblioteca/estandar/premium).
* Mantener cambios al m√≠nimo. No tocamos rules ni la Cloud Function salvo nota al final.

---

## 1) Verificaciones r√°pidas (no cambies nada si ya est√° as√≠)

1. **firebaseConfig.projectId** = `"munabooki"` (sin guiones).
2. **Firestore** creado en el proyecto *munabooki* en modo **Nativo**.
3. **Rules** para `allowlist` (las mismas que ya ten√≠as):

```js
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /allowlist/{email} {
      allow get: if request.auth != null && request.auth.token.email == email;
      allow list, create, update, delete: if false;
    }
  }
}
```

> Si ves `permission-denied` en consola, es porque el usuario no est√° autenticado o el doc no existe. Si vieras `database (default) does not exist`, suele ser **proyecto equivocado** en `firebaseConfig` o cach√©; refresca/limpia cach√© y revisa el `projectId`.

---

## 2) Reemplaza **checkout.html** COMPLETO por este (m√≠nimos cambios)

> Respeta todo el HTML; solo peg√° esto completo.

```html
<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Acceso - Muna Booki</title>
  <!-- SDK de Mercado Pago -->
  <script src="https://sdk.mercadopago.com/js/v2"></script>
  <!-- Tailwind (ok para pruebas; en prod conviene build local) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&family=Pacifico&display=swap" rel="stylesheet" />
  <style>
    :root { --color-dark-blue:#0A2F5B; --color-teal:#00B2A9; --color-gold:#FFC845; }
    body { font-family:'Poppins', sans-serif; }
    .font-cursive { font-family:'Pacifico', cursive; }
    .section-title { color: var(--color-dark-blue); }
    .btn-primary { background-color: var(--color-teal); color:white; }
    .btn-primary:hover { background-color:#009a92; }
    #debug-allowlist { display:none; font-size:12px; color:#64748b; }
  </style>
</head>
<body class="bg-gray-50">

  <!-- Header -->
  <header class="bg-white shadow-sm">
    <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
      <a href="index.html">
        <img src="https://bmeryu.github.io/muna-booki/Logo_MunaBooki.png" alt="Logo de Muna Booki" class="h-16" />
      </a>
      <a href="index.html" class="text-gray-600 hover:text-teal-500 font-semibold">Volver al inicio</a>
    </nav>
  </header>

  <main class="container mx-auto px-6 py-16">
    <div class="max-w-4xl mx-auto grid md:grid-cols-2 gap-12">

      <!-- Columna de Autenticaci√≥n y Pago -->
      <div id="auth-column" class="md:order-2 md:col-span-1">
        <div id="auth-section" class="bg-white p-8 rounded-2xl shadow-lg">
          <h2 id="auth-title" class="text-2xl font-bold text-center section-title mb-2">Casi listo para la magia...</h2>
          <p class="text-center text-gray-600 mb-6">Inicia sesi√≥n o crea tu cuenta para continuar.</p>

          <div class="flex border-b mb-6">
            <button id="login-tab-btn" class="flex-1 py-2 font-semibold text-teal-600 border-b-2 border-teal-600">Iniciar Sesi√≥n</button>
            <button id="register-tab-btn" class="flex-1 py-2 font-semibold text-gray-500">Registrarse</button>
          </div>

          <p id="auth-error-message" class="text-red-500 text-sm text-center mb-4 h-5"></p>

          <form id="login-form" class="space-y-4">
            <input name="email" type="email" placeholder="Correo electr√≥nico" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500" />
            <input name="password" type="password" placeholder="Contrase√±a" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500" />
            <button type="submit" class="w-full btn-primary font-bold py-3 rounded-lg">Ingresar</button>
          </form>
          <form id="register-form" class="space-y-4 hidden">
            <input name="email" type="email" placeholder="Correo electr√≥nico" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500" />
            <input name="password" type="password" placeholder="Crear contrase√±a" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500" />
            <button type="submit" class="w-full btn-primary font-bold py-3 rounded-lg">Crear Cuenta</button>
          </form>

          <div class="my-6 flex items-center">
            <div class="flex-grow border-t border-gray-300"></div>
            <span class="mx-4 text-gray-500 text-sm">o</span>
            <div class="flex-grow border-t border-gray-300"></div>
          </div>

          <div class="space-y-3">
            <button id="google-signin-btn" class="w-full flex items-center justify-center bg-white border border-gray-300 text-gray-700 font-semibold py-3 px-4 rounded-lg hover:bg-gray-50 transition">
              <svg class="w-6 h-6 mr-3" viewBox="0 0 48 48"><defs><path id="a" d="M44.5 20H24v8.5h11.8C34.7 33.9 30.1 37 24 37c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 4.1 29.6 2 24 2 11.8 2 2 11.8 2 24s9.8 22 22 22c11 0 21-8 21-22 0-1.3-.2-2.7-.5-4z"/></defs><clipPath id="b"><use xlink:href="#a" overflow="visible"/></clipPath><path clip-path="url(#b)" fill="#FBBC05" d="M0 37V11l17 13z"/><path clip-path="url(#b)" fill="#EA4335" d="M0 11l17 13 7-6.1L48 14V0H0z"/><path clip-path="url(#b)" fill="#34A853" d="M0 37l30-23 7.9 1L48 0v48H0z"/><path clip-path="url(#b)" fill="#4285F4" d="M48 48L17 24l-4-3 35-10z"/></svg>
              Continuar con Google
            </button>
          </div>
        </div>

        <div id="payment-section" class="bg-white p-8 rounded-2xl shadow-lg mt-8 hidden">
          <h2 id="welcome-message" class="text-2xl font-bold text-center section-title mb-6">¬°Hola, [Nombre Usuario]!</h2>
          <p class="text-center text-gray-600 mb-6">Completa tu compra de forma segura.</p>

          <!-- Mensaje de acceso sin pago -->
          <div id="free-msg" class="text-center text-green-600 font-bold mb-2 hidden">üéâ Est√°s en la lista. No necesitas pagar.</div>
          <div id="debug-allowlist" class="text-center mb-4"></div>

          <div id="clauses-container" class="mb-6 space-y-2 hidden">
            <div class="flex items-start bg-gray-100 p-4 rounded-lg">
              <input id="terms-checkbox" type="checkbox" class="h-5 w-5 text-teal-600 border-gray-300 rounded focus:ring-teal-500 mt-1 cursor-pointer" />
              <label for="terms-checkbox" class="ml-3 text-sm text-gray-800 cursor-pointer">
                Entiendo y acepto las <a href="#" id="terms-trigger" class="font-semibold text-teal-600 hover:underline">Cl√°usulas de Creaci√≥n</a>.
              </label>
            </div>
          </div>

          <!-- Contenedor MP -->
          <div id="mercado-pago-button-container"></div>
        </div>
      </div>

      <div id="order-summary-column" class="md:order-1">
        <h1 class="text-3xl font-bold section-title mb-6">Resumen de tu Compra</h1>
        <div id="order-summary" class="bg-white p-8 rounded-2xl shadow-lg"></div>
        <div class="mt-8 text-gray-600 text-sm flex items-center">
          <svg class="w-5 h-5 mr-2 text-teal-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd"></path></svg>
          <span>Transacci√≥n 100% segura y protegida.</span>
        </div>
      </div>
    </div>
  </main>

  <div id="terms-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4 hidden"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    // Usamos Firestore LITE (sin listeners de tiempo real)
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-lite.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBivlKO0Ijt1hvMNyH9aIGXf_7WZwE2tA4",
      authDomain: "munabooki.firebaseapp.com",
      projectId: "munabooki",
      storageBucket: "munabooki.firebasestorage.app",
      messagingSenderId: "585414544600",
      appId: "1:585414544600:web:77026db4856b0111249bad",
      measurementId: "G-HBM4Y2FKMF"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app); // LITE
    const auth = getAuth(app);
    const googleProvider = new GoogleAuthProvider();

    // MP
    const publicKey = 'APP_USR-a633c3e4-ac28-4661-bba4-0a5dee41e9ed';
    const mp = new MercadoPago(publicKey);

    const qs = new URLSearchParams(location.search);
    const DEBUG = qs.has('debug');

    function showDebug(msg){
      if(!DEBUG) return;
      const el = document.getElementById('debug-allowlist');
      el.style.display = 'block';
      el.textContent = msg;
      console.log('[ALLOWLIST]', msg);
    }

    // Cat√°logo base por querystring (?plan=)
    const planDetails = {
      biblioteca: { id:'plan-001', name:'Suscripci√≥n Biblioteca M√°gica', price:8900, custom:false },
      estandar:   { id:'plan-002', name:'Cuento a Medida',             price:18900, custom:true  },
      premium:    { id:'plan-003', name:'Cuento Premium',              price:40000, custom:true  }
    };

    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      const plan = params.get('plan');
      let handledUid = null;

      onAuthStateChanged(auth, (user) => {
        if (!user) return;
        if (handledUid === user.uid) return; // evitar dobles
        handledUid = user.uid;
        onLoginSuccess(user, plan);
      });

      // Botones auth
      document.getElementById('google-signin-btn').addEventListener('click', async () => {
        try { await signInWithPopup(auth, googleProvider); } catch (e) { console.error(e); }
      });
      document.getElementById('register-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        try { await createUserWithEmailAndPassword(auth, e.target.email.value, e.target.password.value); }
        catch (err) { console.error(err); document.getElementById('auth-error-message').textContent='No se pudo registrar. Revisa tus datos.'; }
      });
      document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        try { await signInWithEmailAndPassword(auth, e.target.email.value, e.target.password.value); }
        catch (err) { console.error(err); document.getElementById('auth-error-message').textContent='Email o contrase√±a incorrectos.'; }
      });
    });

    async function onLoginSuccess(user, plan){
      // UI b√°sica
      const userName = user.displayName || (user.email||'').split('@')[0];
      document.getElementById('welcome-message').textContent = `¬°Hola, ${userName}!`;
      document.getElementById('auth-section').classList.add('hidden');
      document.getElementById('payment-section').classList.remove('hidden');

      // 1) Chequeo ALLOWLIST primero
      const emailExact = (user.email||'');
      const emailLower = emailExact.toLowerCase();
      showDebug(`Email login: ${emailExact}`);

      try {
        let ref = doc(db, 'allowlist', emailLower);
        let snap = await getDoc(ref);
        let data = snap.exists() ? snap.data() : null;

        if (!snap.exists()){
          showDebug(`Doc no encontrado en lower (${emailLower}). Probando exacto...`);
          ref = doc(db, 'allowlist', emailExact);
          snap = await getDoc(ref);
          data = snap.exists() ? snap.data() : null;
        }

        const activeVal = data?.active;
        const isActive = activeVal === true || activeVal === 'true' || activeVal === 1;
        showDebug(`exists=${snap.exists()} | active=${JSON.stringify(activeVal)} | idUsado=${snap.exists()?ref.id:'ninguno'}`);

        if (snap.exists() && isActive){
          // Mensaje y redirecci√≥n inmediata a mi-cuenta
          const msg = document.getElementById('free-msg');
          msg.classList.remove('hidden');
          setTimeout(()=>{ location.replace('mi-cuenta.html?free=1'); }, 600);
          return; // NO montar MP
        }
      } catch(err){
        console.error('Error revisando allowlist:', err);
        showDebug(`Error leyendo allowlist: ${err?.code||''} ${err?.message||err}`);
        // Si hay error de permisos, de todas formas seguimos a pago
      }

      // 2) Construcci√≥n de pedido
      const items = collectItemsFromUIOrQuery(plan);
      renderOrderSummary(items);

      const requiereClausulas = items.some(i => i.custom === true);
      if (requiereClausulas){
        document.getElementById('clauses-container').classList.remove('hidden');
        const terms = document.getElementById('terms-checkbox');
        if (!terms.dataset.listenerAttached){
          terms.addEventListener('change', (e)=>{
            if(e.target.checked) createCheckoutButton(items);
            else document.getElementById('mercado-pago-button-container').innerHTML='';
          });
          terms.dataset.listenerAttached = 'true';
        }
      } else {
        createCheckoutButton(items);
      }
    }

    // Suma productos desde checkboxes si existen; si no, usa ?plan=
    function collectItemsFromUIOrQuery(plan){
      const checkboxes = Array.from(document.querySelectorAll('input[name="product"]:checked'));
      if (checkboxes.length){
        return checkboxes.map(cb=>({ id: cb.value, name: cb.dataset.name, price: Number(cb.dataset.price), qty: 1, custom: cb.dataset.custom === 'true' }));
      }
      const selected = planDetails[plan];
      if (selected){
        return [{ id:selected.id, name:selected.name, price:selected.price, qty:1, custom:selected.custom }];
      }
      // fallback vac√≠o
      return [];
    }

    function renderOrderSummary(items){
      const el = document.getElementById('order-summary');
      if (!items.length){ el.innerHTML = '<p class="text-gray-600">No hay productos seleccionados.</p>'; return; }
      const total = items.reduce((acc,i)=> acc + i.price*(i.qty||1), 0);
      const lines = items.map(i=>`<div class="flex justify-between py-2"><span>${i.name}</span><span>$${i.price.toLocaleString('es-CL')}</span></div>`).join('');
      el.innerHTML = `
        ${lines}
        <div class="border-t mt-4 pt-4 flex justify-between font-bold">
          <span>Total</span><span>$${total.toLocaleString('es-CL')}</span>
        </div>`;
    }

    async function createCheckoutButton(items){
      const container = document.getElementById('mercado-pago-button-container');
      if (window.__creatingWallet) return; window.__creatingWallet = true; container.innerHTML = '';
      try {
        const prefId = await createPreferenceOnBackend(items);
        if (!prefId) throw new Error('No se obtuvo preferenceId desde el backend');
        const bricks = mp.bricks();
        if (window.checkoutButton){ try { await window.checkoutButton.unmount(); } catch(_){} }
        window.checkoutButton = await bricks.create('wallet', 'mercado-pago-button-container', {
          initialization: { preferenceId: prefId },
          customization: { texts: { valueProp: 'smart_option' } }
        });
      } catch(err){
        console.error('Error al crear el bot√≥n de pago:', err);
        container.innerHTML = '<p class="text-red-500 text-sm text-center">No se pudo cargar el bot√≥n de pago. Revisa consola.</p>';
      } finally { window.__creatingWallet = false; }
    }

    async function createPreferenceOnBackend(items){
      const projectId = firebaseConfig.projectId;
      const functionRegion = 'us-central1';
      const url = `https://${functionRegion}-${projectId}.cloudfunctions.net/createMercadoPagoPreference`;

      // Intento #1: enviar items (versi√≥n nueva de la funci√≥n)
      try{
        const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ items: items.map(i=>({ title:i.name, unit_price:i.price, quantity:i.qty||1 })) }) });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const data = await r.json();
        if (data?.preferenceId) return data.preferenceId;
        throw new Error('Respuesta sin preferenceId');
      } catch(e){
        console.warn('Falla createPreference (items). Probando fallback single-item...', e);
      }

      // Intento #2 (fallback): t√≠tulo combinado y total (compatible con funci√≥n antigua)
      const total = items.reduce((acc,i)=> acc + i.price*(i.qty||1), 0);
      const title = items.map(i=> i.name).join(' + ') || 'Muna Booki';
      try{
        const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ title, unit_price: total, quantity: 1 }) });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const data = await r.json();
        return data.preferenceId;
      } catch(e){
        console.error('Error llamando Cloud Function:', e);
        return null;
      }
    }
  </script>
</body>
</html>
```

---

## 3) Notas importantes

* **Redirecci√≥n allowlist:** ahora, si tu email est√° activo en `allowlist`, ves el mensaje y en ~0,6s se va solo a `mi-cuenta.html`.
* **Multi‚Äëproducto:** si agregas checkboxes `<input name="product" ...>` con `data-name`, `data-price` y `data-custom`, el checkout sumar√°. Si no hay checkboxes, sigue funcionando con `?plan=`.
* **HTTP 500 de la Function:** aseg√∫rate de tener el token en variables de entorno (si no, el fallback igual intenta single‚Äëitem pero la funci√≥n debe estar bien):

  ```bash
  firebase functions:config:set mercadopago.token="APP_USR-xxxxxxxx"
  firebase deploy --only functions:createMercadoPagoPreference
  ```
* **Cach√©:** si cambiaste `firebaseConfig` o ve√≠as `database (default) does not exist`, prueba en ventana inc√≥gnita o vac√≠a cach√© duro (Ctrl+Shift+R).

---

## 4) ¬øQuieres que te deje un ejemplo de checkboxes multi‚Äëproducto?

Puedo agregarte un bloque listo para copiar al `order-summary` con tres productos y la suma autom√°tica. P√≠demelo y te lo pego.
